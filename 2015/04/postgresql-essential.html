<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="zh-CN" lang="zh-CN">
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta name="author" content="Jiye Qian" />
    <title>PostgreSQL Essential</title>
    <link rel="shortcut icon" href="/favicon.ico" />
    <link href="/feed/" rel="alternate" title="Jiye Qian" type="application/atom+xml" />
    <link rel="stylesheet" href="/assets/css/style.css" />
    <link rel="stylesheet" href="/assets/css/pygments/default.css" />
    <link rel="stylesheet" href="/assets/css/pygments/default_inline.css" />
    <link rel="stylesheet" href="/assets/css/coderay.css" />
    <link rel="stylesheet" href="/assets/css/twemoji-awesome.css" />  
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
    <link href="/assets/css/jquery-ui-1.10.4.custom.min.css" rel="stylesheet" />
    <link href="/assets/css/ggvis.css" rel="stylesheet" />
    <link href="/assets/css/mermaid.css" rel="stylesheet" />
    <link rel="stylesheet" href="/assets/css/markdown-plus.css"/> 
    <link rel="stylesheet" href="/assets/css/flexslider.css" type="text/css" media="screen" />
      <style type="text/css">
        .flex-caption {
          width: 96%;
          padding: 2%;
          left: 0;
          bottom: 0;
          background: rgba(0,0,0,.5);
          color: #fff;
          text-shadow: 0 -1px 0 rgba(0,0,0,.3);
          font-size: 14px;
          line-height: 18px;
        }
        li.css a {
          border-radius: 0;
        }
      </style>

    <script type="text/javascript" src="/assets/js/jquery.min.js"></script>
    <script type="text/javascript" src="/assets/js/jquery-ui-1.10.4.custom.min.js"></script>
    <script type="text/javascript" src="/assets/js/d3.min.js"></script>
    <script type="text/javascript" src="/assets/js/vega.min.js"></script>
    <script type="text/javascript" src="/assets/js/lodash.min.js"></script>
    <script>var lodash = _.noConflict();</script>
    <script type="text/javascript" src="/assets/js/ggvis.js"></script>
    <script type="text/javascript" src="/assets/js/htmlwidgets.js"></script>
    <script type="text/javascript" src="/assets/js/echarts-all.js"></script>
    <script type="text/javascript" src="/assets/js/echarts.js"></script>
    <script defer src="/assets/js/jquery.flexslider-min.js"></script>
    <script type="text/javascript">
      // $(function(){
      //   SyntaxHighlighter.all();
      // });
      $(window).load(function(){
        $('.flexslider').flexslider({
          animation: "slide",
          start: function(slider){
            $('body').removeClass('loading');
          }
        });
      });
    </script>

    <script type="text/javascript">
      function setTimeSpan(){
        var date = new Date();
        timeSpan.innerText=date.format('yyyy-MM-dd hh:mm:ss');
      }

      Date.prototype.format = function(format)
      {
        var o =
        {
          "M+" : this.getMonth()+1, //month
          "d+" : this.getDate(),    //day
          "h+" : this.getHours(),   //hour
          "m+" : this.getMinutes(), //minute
          "s+" : this.getSeconds(), //second
          "q+" : Math.floor((this.getMonth()+3)/3),  //quarter
          "S" : this.getMilliseconds() //millisecond
        }
        if(/(y+)/.test(format))
          format=format.replace(RegExp.$1,(this.getFullYear()+"").substr(4 - RegExp.$1.length));
        for(var k in o)
          if(new RegExp("("+ k +")").test(format))
            format = format.replace(RegExp.$1,RegExp.$1.length==1 ? o[k] : ("00"+ o[k]).substr((""+ o[k]).length));
          return format;
        }
      </script>

    <!-- MathJax for LaTeX -->
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        "HTML-CSS": { extensions: ["handle-floats.js"] },
        TeX: { equationNumbers: { autoNumber: "AMS" } },
        tex2jax: {
            inlineMath: [['$$$', '$$$'], ['$', '$'], ['\\(', '\\)']],
            processEscapes: true
        }
    });
    </script>
    <!-- <script type="text/javascript" src="/assets/js/mathjax/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script> -->
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
  
  <!-- <script type="text/javascript">
var _bdhmProtocol = (("https:" == document.location.protocol) ? " https://" : " http://");
document.write(unescape("%3Cscript src='" + _bdhmProtocol + "hm.baidu.com/h.js%3F0b514f17fd99b9fb4be74c94bdd2b7db' type='text/javascript'%3E%3C/script%3E"));
</script>
 -->
  </head>
<!--  <body>
-->

  <body onLoad="setInterval(setTimeSpan,1000);">
    <div id="container">
      <div id="main" role="main">
        <header>
        <h1>PostgreSQL Essential</h1>
        </header>
        <nav id="real_nav">
        
          <span><a title="Home" href="/">Home</a></span>
        
          <span><a title="Categories" href="/categories/">Categories</a></span>
        
          <span><a title="Tags" href="/tags/">Tags</a></span>
        
          <span><a title="About" href="/about/">About</a></span>
        
          <span><a title="Search" href="/search/">Search</a></span>
        
        </nav>
        <article class="content">
        <script type="text/javascript" src="/assets/js/outliner.js"></script>

<section class="meta">
<span class="time">
  <time datetime="2015-04-20">2015-04-20</time>
</span>

 |
<span class="categories">
  <i class="fa fa-share-alt"></i>
  
  <a href="/categories/#振导社会" title="振导社会">振导社会</a>&nbsp;
  
</span>


 |
<span class="tags">
  <i class="fa fa-tags"></i>
  
  <a href="/tags/#程序设计" title="程序设计">程序设计</a>&nbsp;
  
  <a href="/tags/#SQL" title="SQL">SQL</a>&nbsp;
  
</span>

</section>
<section class="post">
<h2 class="no_toc" id="section">目录</h2>

<ul id="markdown-toc">
  <li><a href="#section-1" id="markdown-toc-section-1">基本应用</a>    <ul>
      <li><a href="#section-2" id="markdown-toc-section-2">入门</a></li>
      <li><a href="#datatype" id="markdown-toc-datatype">数据类型</a></li>
      <li><a href="#section-3" id="markdown-toc-section-3">查询操作</a>        <ul>
          <li><a href="#group-by--having" id="markdown-toc-group-by--having"><code>GROUP BY</code> &amp; <code>HAVING</code></a></li>
          <li><a href="#section-4" id="markdown-toc-section-4">嵌套查询</a></li>
          <li><a href="#functions-matching" id="markdown-toc-functions-matching">模式匹配</a></li>
        </ul>
      </li>
      <li><a href="#section-5" id="markdown-toc-section-5">用户管理</a></li>
      <li><a href="#section-6" id="markdown-toc-section-6">数据库管理</a></li>
      <li><a href="#section-7" id="markdown-toc-section-7">表管理</a>        <ul>
          <li><a href="#section-8" id="markdown-toc-section-8">创建表</a></li>
          <li><a href="#ddl-alter" id="markdown-toc-ddl-alter">修改表</a></li>
          <li><a href="#section-9" id="markdown-toc-section-9">数据操作</a></li>
          <li><a href="#section-10" id="markdown-toc-section-10">表之间的连接</a></li>
        </ul>
      </li>
      <li><a href="#section-11" id="markdown-toc-section-11">实用技术</a>        <ul>
          <li><a href="#psqlsql" id="markdown-toc-psqlsql">psql运行SQL文件</a></li>
          <li><a href="#section-12" id="markdown-toc-section-12">文件与表单数据的导入与导出</a></li>
          <li><a href="#section-13" id="markdown-toc-section-13">基本配置</a></li>
        </ul>
      </li>
    </ul>
  </li>
  <li><a href="#section-14" id="markdown-toc-section-14">高级应用</a>    <ul>
      <li><a href="#section-15" id="markdown-toc-section-15">视图</a></li>
      <li><a href="#section-16" id="markdown-toc-section-16">外键</a></li>
      <li><a href="#section-17" id="markdown-toc-section-17">继承</a></li>
      <li><a href="#section-18" id="markdown-toc-section-18">事务</a></li>
      <li><a href="#section-19" id="markdown-toc-section-19">窗函数</a></li>
      <li><a href="#with" id="markdown-toc-with"><code>WITH</code>查询</a></li>
    </ul>
  </li>
  <li><a href="#section-20" id="markdown-toc-section-20">聚合函数</a>    <ul>
      <li><a href="#tutorial-agg" id="markdown-toc-tutorial-agg">基本用法</a></li>
      <li><a href="#section-21" id="markdown-toc-section-21">自定义聚合函数</a></li>
    </ul>
  </li>
  <li><a href="#sql-expressions" id="markdown-toc-sql-expressions">值表达式</a></li>
  <li><a href="#plpgsqlplpgsql" id="markdown-toc-plpgsqlplpgsql">PL/pgSQL</a></li>
  <li><a href="#plpythonplpython" id="markdown-toc-plpythonplpython">PL/Python</a></li>
  <li><a href="#section-22" id="markdown-toc-section-22">参考资料</a></li>
</ul>

<h2 id="section-1">基本应用</h2>

<p>SQL操作主要包括<code>SELECT</code>、<code>CREATE</code>、<code>ALTER</code>、<code>REVOKE</code>、<code>DROP</code>、<code>SET</code>和<code>SELECT</code>等，几个通用的基本操作为查询（<code>SELECT</code>）、创建（<code>CREATE</code>）、更改（<code>ALTER</code>）、删除（<code>DROP</code>）……</p>

<h3 id="section-2">入门</h3>

<p>进行PostgreSQL的任何操作前，须在磁盘上初始化数据库存储空间，这称为数据库簇（database cluster）：</p>

<div class="highlight"><pre><code class="language-bash"><span class="nv">$ </span>initdb -D /usr/local/var/postgres/data</code></pre></div>

<p>PostgreSQL采用客户端／服务器的工作模式，如果要管理数据库，需要先启动服务进程：</p>

<div class="highlight"><pre><code class="language-bash"><span class="nv">$ </span>pg_ctl start -D /usr/local/var/postgres/data</code></pre></div>

<p>可以在环境变量中设置代替命令中的<code>-D</code>参数：</p>

<div class="highlight"><pre><code class="language-bash"><span class="nb">export </span><span class="nv">PGDATA</span><span class="o">=</span>/usr/local/var/postgres/data</code></pre></div>

<p>通过管理工具PostgreSQL可以操控数据库，流行的三大管理工具是命令行的psql、图形界面的<a href="http://www.pgadmin.org">pgAdmin</a>、网页版的<a href="http://phppgadmin.sourceforge.net">PHPPgAdmin</a>，管理工具以客户端的形式接入。psql的接入方式：</p>

<div class="highlight"><pre><code class="language-bash"><span class="nv">$ </span>psql -U user -d exampledb -h 127.0.0.1 -p 5432
<span class="nv">$ </span>psql -l <span class="c">#列出所有数据库</span></code></pre></div>

<p>创建数据库：</p>

<div class="highlight"><pre><code class="language-bash"><span class="nv">$ </span>createdb 数据库名</code></pre></div>

<p>删除数据库：</p>

<div class="highlight"><pre><code class="language-bash"><span class="nv">$ </span>dropdb 数据库名</code></pre></div>

<p>psql的基本管理命令如下：</p>

<ul>
  <li><code>\h</code>：查看SQL命令的解释，比如<code>\h select</code>；</li>
  <li><code>\?</code>：查看psql命令列表；</li>
  <li><code>\l</code>：列出所有数据库；</li>
  <li><code>\c [database_name]</code>：连接其他数据库；</li>
  <li><code>\d</code>：列出当前数据库的所有表格；</li>
  <li><code>\d [table_name]</code>：列出某一张表格的结构；</li>
  <li><code>\dt</code>：列出所有的表；</li>
  <li><code>\du</code>：列出所有用户；</li>
  <li><code>\e</code>：打开文本编辑器；</li>
  <li><code>\conninfo</code>：列出当前数据库和连接的信息。</li>
</ul>

<h3 id="datatype">数据类型<sup id="fnref:datatype"><a href="#fn:datatype" class="footnote">1</a></sup></h3>

<p>PostgreSQL的数据类型包括：数值类型、货币类型、字符类型、二值类型、日期／时间类型、枚举类型、地理类型、网络地址类型、位字符串类型、文本搜索类型、UUID类型、XML类型、JSON类型、数组、复合类型、范围类型、对象标志类型、pg_lsn类型、伪类型。</p>

<h3 id="section-3">查询操作</h3>

<h4 id="group-by--having"><code>GROUP BY</code> &amp; <code>HAVING</code></h4>

<p>经过<code>WHERE</code>语句过滤后，输入表可通过<code>GROUP BY</code>分组，并且利用<code>HAVING</code>排除不满足条件的分组。</p>

<h4 id="section-4">嵌套查询</h4>

<p>查询sender最新发的消息，结果再按最新优先排序：</p>

<div class="highlight"><pre><code class="language-sql"><span class="c1">-- +------------+-------------+----------+</span>
<span class="c1">-- | sender_id  |  created_at | message  |</span>
<span class="c1">-- +------------+-------------+----------+</span>
<span class="c1">-- |      1     | 2010-06-14  | the msg  |</span>
<span class="c1">-- |      1     | 2010-06-15  | the msg  |</span>
<span class="c1">-- |      2     | 2010-06-16  | the msg  |</span>
<span class="c1">-- |      3     | 2010-06-14  | the msg  |</span>
<span class="c1">-- +------------+-------------+----------|</span>

<span class="k">SELECT</span>  <span class="o">*</span>
<span class="k">FROM</span>    <span class="p">(</span>
        <span class="k">SELECT</span> <span class="k">DISTINCT</span> <span class="k">ON</span> <span class="p">(</span><span class="n">sender_id</span><span class="p">)</span> <span class="o">*</span>
        <span class="k">FROM</span> <span class="n">messages</span> 
        <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">sender_id</span><span class="p">,</span> <span class="n">created_at</span> <span class="k">DESC</span> 
        <span class="p">)</span> <span class="n">q</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="n">created_at</span> <span class="k">DESC</span><span class="p">;</span>

<span class="c1">-- 等价于：</span>
<span class="k">WITH</span> <span class="n">q</span> <span class="k">AS</span> <span class="p">(</span>
    <span class="k">SELECT</span> <span class="k">DISTINCT</span> <span class="k">ON</span> <span class="p">(</span><span class="n">sender_id</span><span class="p">)</span> <span class="o">*</span>
    <span class="k">FROM</span> <span class="n">messages</span> 
    <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">sender_id</span><span class="p">,</span> <span class="n">created_at</span> <span class="k">DESC</span> 
<span class="p">)</span> 
<span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">q</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">created_at</span> <span class="k">DESC</span><span class="p">;</span></code></pre></div>

<h4 id="functions-matching">模式匹配<sup id="fnref:functions-matching"><a href="#fn:functions-matching" class="footnote">2</a></sup></h4>

<h3 id="section-5">用户管理</h3>

<p>PostgreSQL只有一种类型的账户，称之为<strong>角色</strong>（role）。当角色拥有登陆（login）权限时，称之为<strong>用户</strong>（user）。角色也可作为其它角色的成员，拥有其他角色成员的角色称为<strong>组</strong>（group）。</p>

<p>PostgreSQL第一次初始化时创建会账户postgres以及同名的数据库postgres，以该用户登录，利用psql或pgAdmin可以创建其它用户。</p>

<p>创建有效期为<code>infinity</code>（也是默认值）的用户：</p>

<div class="highlight"><pre><code class="language-sql"><span class="k">CREATE</span> <span class="k">ROLE</span> <span class="n">leo</span> <span class="n">LOGIN</span> <span class="n">PASSWORD</span> <span class="s1">&#39;lion!king&#39;</span> <span class="k">CREATEDB</span> <span class="k">VALID</span> <span class="k">UNTIL</span> <span class="s1">&#39;infinity&#39;</span><span class="p">;</span></code></pre></div>

<p>创建超级用户：</p>

<div class="highlight"><pre><code class="language-sql"><span class="k">CREATE</span> <span class="k">ROLE</span> <span class="n">regina</span> <span class="n">LOGIN</span> <span class="n">PASSWORD</span> <span class="s1">&#39;queen!penultimate&#39;</span> <span class="n">SUPERUSER</span> <span class="k">VALID</span> <span class="k">UNTIL</span> <span class="s1">&#39;2020-10-20 23:00&#39;</span><span class="p">;</span></code></pre></div>

<p>一般情况，组角色拥有其成员角色登录权限以外的其它权限。也可以创建用于登录权限的组。创建组<code>jungle</code>（默认值为<code>INHERIT</code>），并添加用户<code>leo</code>到组：</p>

<div class="highlight"><pre><code class="language-sql"><span class="k">CREATE</span> <span class="k">ROLE</span> <span class="n">jungle</span> <span class="n">INHERIT</span><span class="p">;</span>
<span class="k">GRANT</span> <span class="n">jungle</span> <span class="k">TO</span> <span class="n">leo</span><span class="p">;</span></code></pre></div>

<p>通过<code>ALTER</code>分配用户权限：</p>

<div class="highlight"><pre><code class="language-sql"><span class="k">ALTER</span> <span class="k">ROLE</span> <span class="n">jungle</span> <span class="k">WITH</span> <span class="n">CREATEROLE</span><span class="p">;</span></code></pre></div>

<p>通过<code>REVOKE</code>收回用户权限：</p>

<div class="highlight"><pre><code class="language-sql"><span class="k">REVOKE</span> <span class="k">ALL</span> <span class="k">ON</span> <span class="ss">&quot;tabelname&quot;</span> <span class="k">from</span> <span class="n">jungle</span><span class="p">;</span></code></pre></div>

<p><strong>注意：</strong></p>

<ul>
  <li>PostgreSQL能够使其成员角色不拥有该组的权限；</li>
  <li>角色的一些权限不能被其成员继承，比如超级用户。</li>
</ul>

<h3 id="section-6">数据库管理</h3>

<div class="highlight"><pre><code class="language-sql"><span class="k">CREATE</span> <span class="k">DATABASE</span> <span class="n">mydb</span><span class="p">;</span></code></pre></div>

<p>这将以登录用户作为拥有者（owner），创建数据库，该数据库是模版数据库template1的拷贝。<strong>模版数据库</strong>（template database）可作为创建其它数据库的模版，任何数据库都可作为模版数据库：</p>

<div class="highlight"><pre><code class="language-sql"><span class="k">UPDATE</span> <span class="n">pg_database</span> <span class="k">SET</span> <span class="n">datistemplate</span><span class="o">=</span><span class="k">true</span> <span class="k">WHERE</span> <span class="n">datname</span><span class="o">=</span><span class="s1">&#39;mydb&#39;</span><span class="p">;</span></code></pre></div>

<p>标记为模版数据库的数据库不能被删除，可以被拥有<code>CREATEDB</code>权限的用户用于创建新的数据库。<code>template1</code>是默认的模版数据库，编码（encoding）不能修改。如果需要修改编码或者不需要template1中的扩展（extension），可以用模版数据库<code>template0</code>：</p>

<div class="highlight"><pre><code class="language-sql"><span class="k">CREATE</span> <span class="k">DATABASE</span> <span class="n">mydb</span> <span class="k">TEMPLATE</span> <span class="n">template0</span><span class="p">;</span></code></pre></div>

<h3 id="section-7">表管理</h3>

<p>查看当前数据库的所有表：</p>

<div class="highlight"><pre><code class="language-bash"><span class="se">\d</span>t

--             List of relations
--  Schema <span class="p">|</span>     Name     <span class="p">|</span> Type  <span class="p">|</span>  Owner   
-- --------+--------------+-------+----------
--  public <span class="p">|</span> distributors <span class="p">|</span> table <span class="p">|</span> jiyeqian
--  public <span class="p">|</span> user         <span class="p">|</span> table <span class="p">|</span> jiyeqian</code></pre></div>

<p>如果表名与SQL的关键字相同，需要加上作用域，或者只加双引号：</p>

<div class="highlight"><pre><code class="language-sql"><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="k">public</span><span class="p">.</span><span class="ss">&quot;user&quot;</span><span class="p">;</span>
<span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="ss">&quot;user&quot;</span><span class="p">;</span></code></pre></div>

<p><strong>如果SQL的关键字与定义的名字相同，需要对名字加双引号，如上删除表格的例子。</strong></p>

<h4 id="section-8">创建表</h4>

<p><a href="http://www.postgresql.org/docs/current/static/sql-createtable.html">创建表</a>就是创建不同<a href="#datatype">数据类型</a>的字段。除了数据类型外，创建表格的参数还包括：</p>

<ul>
  <li>列／字段约束（column_constraint）：<code>NOT NULL</code>、<code>PRIMARY KEY</code>（可视为<code>UNIQUE</code>和<code>NOT NULL</code>的组合）、<code>DEFAULT</code></li>
  <li>表约束（table_constraint）：<code>PRIMARY KEY</code></li>
  <li>like选项（like_option）：<code>INCLUDING</code></li>
</ul>

<div class="highlight"><pre><code class="language-sql"><span class="c1">-- 直接通过CREATE创建</span>
<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="ss">&quot;user&quot;</span>
<span class="p">(</span>
  <span class="n">id</span> <span class="nb">serial</span> <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">,</span>
  <span class="n">user_id</span> <span class="nb">integer</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span> 
  <span class="n">item_id</span> <span class="nb">integer</span><span class="p">,</span>  
  <span class="n">behavior_type</span> <span class="nb">smallint</span><span class="p">,</span> 
  <span class="n">user_geohash</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span> 
  <span class="n">item_category</span> <span class="nb">integer</span><span class="p">,</span> 
  <span class="n">time</span> <span class="k">timestamp</span> <span class="k">with</span> <span class="n">time</span> <span class="k">zone</span>
<span class="p">);</span>

<span class="c1">-- 依照表格创建新表</span>
<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">table2</span><span class="p">(</span><span class="k">like</span> <span class="n">table1</span><span class="p">);</span>

<span class="c1">-- 基于查询结果创建表</span>
<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">visit_log</span> <span class="k">AS</span> <span class="k">SELECT</span> <span class="n">id</span> <span class="k">AS</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">time</span> <span class="k">FROM</span> <span class="ss">&quot;user&quot;</span> <span class="k">LIMIT</span> <span class="mi">10</span><span class="p">;</span></code></pre></div>

<h4 id="ddl-alter">修改表<sup id="fnref:ddl-alter"><a href="#fn:ddl-alter" class="footnote">3</a></sup></h4>

<div class="highlight"><pre><code class="language-sql"><span class="c1">-- 增加字段（列）：</span>
<span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">products</span> <span class="k">ADD</span> <span class="k">COLUMN</span> <span class="n">description</span> <span class="nb">text</span><span class="p">;</span> 
<span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">products</span> <span class="k">ADD</span> <span class="k">COLUMN</span> <span class="n">description</span> <span class="nb">text</span> <span class="k">CHECK</span> <span class="p">(</span><span class="n">description</span> <span class="o">&lt;&gt;</span> <span class="s1">&#39;&#39;</span><span class="p">);</span>  <span class="c1">-- 增加字段（列）及约束条件</span>

<span class="c1">-- 删除字段：</span>
<span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">products</span> <span class="k">DROP</span> <span class="k">COLUMN</span> <span class="n">description</span><span class="p">;</span> 
<span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">products</span> <span class="k">DROP</span> <span class="k">COLUMN</span> <span class="n">description</span> <span class="k">CASCADE</span><span class="p">;</span> <span class="c1">-- 删除有依赖关系的字段</span>

<span class="c1">-- 增加约束条件：</span>
<span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">products</span> <span class="k">ADD</span> <span class="k">CHECK</span> <span class="p">(</span><span class="n">name</span> <span class="o">&lt;&gt;</span> <span class="s1">&#39;&#39;</span><span class="p">);</span>
<span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">products</span> <span class="k">ADD</span> <span class="k">CONSTRAINT</span> <span class="n">some_name</span> <span class="k">UNIQUE</span> <span class="p">(</span><span class="n">product_no</span><span class="p">);</span>
<span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">products</span> <span class="k">ADD</span> <span class="k">FOREIGN</span> <span class="k">KEY</span> <span class="p">(</span><span class="n">product_group_id</span><span class="p">)</span> <span class="k">REFERENCES</span> <span class="n">product_groups</span><span class="p">;</span>

<span class="c1">-- 删除约束条件：</span>
<span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">products</span> <span class="k">DROP</span> <span class="k">CONSTRAINT</span> <span class="n">some_name</span><span class="p">;</span>
<span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">products</span> <span class="k">ALTER</span> <span class="k">COLUMN</span> <span class="n">product_no</span> <span class="k">DROP</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">;</span>

<span class="c1">-- 修改字段默认值：</span>
<span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">products</span> <span class="k">ALTER</span> <span class="k">COLUMN</span> <span class="n">price</span> <span class="k">SET</span> <span class="k">DEFAULT</span> <span class="mi">7</span><span class="p">.</span><span class="mi">77</span><span class="p">;</span>
<span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">products</span> <span class="k">ALTER</span> <span class="k">COLUMN</span> <span class="n">price</span> <span class="k">DROP</span> <span class="k">DEFAULT</span><span class="p">;</span>

<span class="c1">-- 修改字段数据类型：</span>
<span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">products</span> <span class="k">ALTER</span> <span class="k">COLUMN</span> <span class="n">price</span> <span class="k">TYPE</span> <span class="nb">numeric</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">2</span><span class="p">);</span>

<span class="c1">-- 字段重命名：</span>
<span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">products</span> <span class="k">RENAME</span> <span class="k">COLUMN</span> <span class="n">product_no</span> <span class="k">TO</span> <span class="n">product_number</span><span class="p">;</span>

<span class="c1">-- 表重命名：</span>
<span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">products</span> <span class="k">RENAME</span> <span class="k">TO</span> <span class="n">items</span><span class="p">;</span></code></pre></div>

<h4 id="section-9">数据操作</h4>

<p>插入数据：</p>

<div class="highlight"><pre><code class="language-sql"><span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">products</span> <span class="k">VALUES</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;Cheese&#39;</span><span class="p">,</span> <span class="mi">9</span><span class="p">.</span><span class="mi">99</span><span class="p">);</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">products</span> <span class="p">(</span><span class="n">product_no</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">price</span><span class="p">)</span> <span class="k">VALUES</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;Cheese&#39;</span><span class="p">,</span> <span class="mi">9</span><span class="p">.</span><span class="mi">99</span><span class="p">);</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">products</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">price</span><span class="p">,</span> <span class="n">product_no</span><span class="p">)</span> <span class="k">VALUES</span> <span class="p">(</span><span class="s1">&#39;Cheese&#39;</span><span class="p">,</span> <span class="mi">9</span><span class="p">.</span><span class="mi">99</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">products</span> <span class="p">(</span><span class="n">product_no</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span> <span class="k">VALUES</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;Cheese&#39;</span><span class="p">);</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">products</span> <span class="k">VALUES</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;Cheese&#39;</span><span class="p">);</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">products</span> <span class="p">(</span><span class="n">product_no</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">price</span><span class="p">)</span> <span class="k">VALUES</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;Cheese&#39;</span><span class="p">,</span> <span class="k">DEFAULT</span><span class="p">);</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">products</span> <span class="k">DEFAULT</span> <span class="k">VALUES</span><span class="p">;</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">products</span> <span class="p">(</span><span class="n">product_no</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">price</span><span class="p">)</span> <span class="k">VALUES</span>
    <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;Cheese&#39;</span><span class="p">,</span> <span class="mi">9</span><span class="p">.</span><span class="mi">99</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;Bread&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">.</span><span class="mi">99</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;Milk&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">.</span><span class="mi">99</span><span class="p">);</span></code></pre></div>

<p>更新数据：</p>

<div class="highlight"><pre><code class="language-sql"><span class="k">UPDATE</span> <span class="n">products</span> <span class="k">SET</span> <span class="n">price</span> <span class="o">=</span> <span class="mi">10</span> <span class="k">WHERE</span> <span class="n">price</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
<span class="k">UPDATE</span> <span class="n">products</span> <span class="k">SET</span> <span class="n">price</span> <span class="o">=</span> <span class="n">price</span> <span class="o">*</span> <span class="mi">1</span><span class="p">.</span><span class="mi">10</span><span class="p">;</span>
<span class="k">UPDATE</span> <span class="n">products</span> <span class="k">SET</span> <span class="n">time</span> <span class="o">=</span> <span class="n">to_timestamp</span><span class="p">(</span><span class="n">time_str</span><span class="p">,</span> <span class="s1">&#39;yyyy-mm-dd HH24&#39;</span><span class="p">);</span>
<span class="k">UPDATE</span> <span class="n">mytable</span> <span class="k">SET</span> <span class="n">a</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="k">c</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">WHERE</span> <span class="n">a</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span></code></pre></div>

<p>删除数据：</p>

<div class="highlight"><pre><code class="language-sql"><span class="k">DELETE</span> <span class="k">FROM</span> <span class="n">products</span> <span class="k">WHERE</span> <span class="n">price</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
<span class="k">DELETE</span> <span class="k">FROM</span> <span class="n">products</span><span class="p">;</span></code></pre></div>

<h4 id="section-10">表之间的连接</h4>

<h3 id="section-11">实用技术</h3>

<h4 id="psqlsql">psql运行SQL文件</h4>

<p>今有创建表的SQL语句文件create_table_user.sql，内容如下：</p>

<div class="highlight"><pre><code class="language-sql"><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="ss">&quot;user&quot;</span>
<span class="p">(</span>
  <span class="n">id</span> <span class="nb">serial</span> <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">,</span>
  <span class="n">user_id</span> <span class="nb">integer</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span> 
  <span class="n">item_id</span> <span class="nb">integer</span><span class="p">,</span>  
  <span class="n">behavior_type</span> <span class="nb">smallint</span><span class="p">,</span> 
  <span class="n">user_geohash</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span> 
  <span class="n">item_category</span> <span class="nb">integer</span><span class="p">,</span> 
  <span class="n">time</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span>
<span class="p">)</span></code></pre></div>

<p>在psql命令控制台执行运行sql文件的格式为<code>\i [file.sql]</code>:</p>

<div class="highlight"><pre><code class="language-bash"><span class="se">\i</span> create_table_user.sql</code></pre></div>

<h4 id="section-12">文件与表单数据的导入与导出</h4>

<p>导入前需要先建表，表单字段的数据类型决定了导入数据的类型。将CSV文件导入到表：</p>

<div class="highlight"><pre><code class="language-sql"><span class="k">COPY</span> <span class="ss">&quot;user&quot;</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">item_id</span><span class="p">,</span> <span class="n">behavior_type</span><span class="p">,</span> <span class="n">user_geohash</span><span class="p">,</span> <span class="n">item_category</span><span class="p">,</span> <span class="n">time</span><span class="p">)</span>
<span class="k">FROM</span> <span class="s1">&#39;/abspath/tianchi_mobile_recommend_train_user.csv&#39;</span> <span class="k">WITH</span> <span class="n">CSV</span> <span class="n">HEADER</span><span class="p">;</span></code></pre></div>

<p>将表导出到文件：</p>

<div class="highlight"><pre><code class="language-sql"><span class="k">COPY</span> <span class="ss">&quot;user&quot;</span> <span class="k">TO</span> <span class="s1">&#39;/abspath/tianchi_mobile_recommend_train_user.csv&#39;</span> <span class="k">WITH</span> <span class="n">CSV</span> <span class="n">HEADER</span><span class="p">;</span>

<span class="c1">-- 导出查询结果</span>
<span class="k">COPY</span> <span class="p">(</span><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">country</span> <span class="k">WHERE</span> <span class="n">country_name</span> <span class="k">LIKE</span> <span class="s1">&#39;A%&#39;</span><span class="p">)</span> <span class="k">TO</span> <span class="s1">&#39;/usr1/proj/bray/sql/a_list_countries.copy&#39;</span><span class="p">;</span>

<span class="c1">-- 导出结果打包</span>
<span class="k">COPY</span> <span class="n">country</span> <span class="k">TO</span> <span class="n">PROGRAM</span> <span class="s1">&#39;gzip &gt; /usr1/proj/bray/sql/country_data.gz&#39;</span><span class="p">;</span></code></pre></div>

<p><strong>注意：</strong></p>

<ul>
  <li>文件须使用绝对路径。</li>
  <li>不要混淆<code>COPY</code>和psql指令<code>\copy</code>。 <code>\copy</code>调用<code>COPY FROM STDIN</code>或者<code>COPY TO STDOUT</code>，然后把数据抓取/存储到一个psql客户端可以访问的文件中。</li>
  <li>在SQL标准里没有<code>COPY</code>语句。</li>
</ul>

<h4 id="section-13">基本配置</h4>

<p>PostgreSQL通过三个主要被配文件控制其基本操作，这三个文件位于数据文件夹：</p>

<ol>
  <li>postgresql.conf：基本设置，包括：内存分配、新建数据库的默认存放位置、监听IP等；</li>
  <li>pg_hba.conf：安全控制，控制访问权限 ；</li>
  <li>pg_ident.conf：将授权的操作系统用户映射为PostgreSQL用户。</li>
</ol>

<p>当连接到任意数据库时，超级用户可以通过SQL查看这三个文件的位置：</p>

<div class="highlight"><pre><code class="language-sql"><span class="k">SELECT</span> <span class="n">name</span><span class="p">,</span> <span class="n">setting</span> <span class="k">FROM</span> <span class="n">pg_settings</span> <span class="k">WHERE</span> <span class="n">category</span> <span class="o">=</span> <span class="s1">&#39;File Locations&#39;</span><span class="p">;</span></code></pre></div>

<p>可以通过SQL查看postgresql.conf的当前配置：</p>

<div class="highlight"><pre><code class="language-sql"><span class="k">SELECT</span> <span class="n">name</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">unit</span><span class="p">,</span> <span class="n">setting</span><span class="p">,</span> <span class="n">boot_val</span><span class="p">,</span> <span class="n">reset_val</span>
<span class="k">FROM</span> <span class="n">pg_settings</span>
<span class="k">WHERE</span> <span class="n">name</span> <span class="k">in</span><span class="p">(</span><span class="s1">&#39;listen_addresses&#39;</span><span class="p">,</span><span class="s1">&#39;max_connections&#39;</span><span class="p">,</span><span class="s1">&#39;shared_buffers&#39;</span><span class="p">,</span><span class="s1">&#39;effective_cache_size&#39;</span><span class="p">,</span> <span class="s1">&#39;work_mem&#39;</span><span class="p">,</span> <span class="s1">&#39;maintenance_work_mem&#39;</span><span class="p">)</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="n">context</span><span class="p">,</span><span class="n">name</span><span class="p">;</span>

<span class="c1">--          name         |  context   | unit |  setting  | boot_val  | reset_val </span>
<span class="c1">-- ----------------------+------------+------+-----------+-----------+-----------</span>
<span class="c1">--  listen_addresses     | postmaster |      | localhost | localhost | localhost</span>
<span class="c1">--  max_connections      | postmaster |      | 100       | 100       | 100</span>
<span class="c1">--  shared_buffers       | postmaster | 8kB  | 16384     | 1024      | 16384</span>
<span class="c1">--  effective_cache_size | user       | 8kB  | 524288    | 524288    | 524288</span>
<span class="c1">--  maintenance_work_mem | user       | kB   | 65536     | 65536     | 65536</span>
<span class="c1">--  work_mem             | user       | kB   | 4096      | 4096      | 4096</span></code></pre></div>

<p>context的值为postmaster，表示改变参数需要重启服务才生效；context的值为user，表示改变至少需要重新加载生效。这些设置也能在数据库、用户、会话和函数被覆盖（overridden）。</p>

<p>重新加载不会影响到活动连接：</p>

<div class="highlight"><pre><code class="language-bash"><span class="nv">$ </span>pg_ctl reload -D your_data_directory_here</code></pre></div>

<h2 id="section-14">高级应用</h2>

<h3 id="section-15">视图</h3>

<h3 id="section-16">外键</h3>

<h3 id="section-17">继承</h3>

<h3 id="section-18">事务</h3>

<h3 id="section-19">窗函数</h3>

<h3 id="with"><code>WITH</code>查询</h3>

<p><code>WITH</code>为大规模查询书提供了写辅助语句的方法。这些语句通常称为通用表表达式（CTE，common table expressions），它们可以被当作临时表，仅供一次查询使用。<code>WITH</code>语句中的辅助语句可以是<code>SELECT</code>、<code>INSERT</code>、<code>UPDATE</code>或<code>DELETE</code>，<code>WITH</code>语句本生也带有<code>SELECT</code>、<code>INSERT</code>、<code>UPDATE</code>或<code>DELETE</code>的主语句。</p>

<p><code>WITH</code>语句包含的<code>SELECT</code>语句的基本功能是将复杂的查询分割为多部分，比如：</p>

<div class="highlight"><pre><code class="language-sql"><span class="k">WITH</span> <span class="n">regional_sales</span> <span class="k">AS</span> <span class="p">(</span>
        <span class="k">SELECT</span> <span class="n">region</span><span class="p">,</span> <span class="k">SUM</span><span class="p">(</span><span class="n">amount</span><span class="p">)</span> <span class="k">AS</span> <span class="n">total_sales</span>
        <span class="k">FROM</span> <span class="n">orders</span>
        <span class="k">GROUP</span> <span class="k">BY</span> <span class="n">region</span>
     <span class="p">),</span> <span class="n">top_regions</span> <span class="k">AS</span> <span class="p">(</span>
        <span class="k">SELECT</span> <span class="n">region</span>
        <span class="k">FROM</span> <span class="n">regional_sales</span>
        <span class="k">WHERE</span> <span class="n">total_sales</span> <span class="o">&gt;</span> <span class="p">(</span><span class="k">SELECT</span> <span class="k">SUM</span><span class="p">(</span><span class="n">total_sales</span><span class="p">)</span><span class="o">/</span><span class="mi">10</span> <span class="k">FROM</span> <span class="n">regional_sales</span><span class="p">)</span>
     <span class="p">)</span>
<span class="k">SELECT</span> <span class="n">region</span><span class="p">,</span>
       <span class="n">product</span><span class="p">,</span>
       <span class="k">SUM</span><span class="p">(</span><span class="n">quantity</span><span class="p">)</span> <span class="k">AS</span> <span class="n">product_units</span><span class="p">,</span>
       <span class="k">SUM</span><span class="p">(</span><span class="n">amount</span><span class="p">)</span> <span class="k">AS</span> <span class="n">product_sales</span>
<span class="k">FROM</span> <span class="n">orders</span>
<span class="k">WHERE</span> <span class="n">region</span> <span class="k">IN</span> <span class="p">(</span><span class="k">SELECT</span> <span class="n">region</span> <span class="k">FROM</span> <span class="n">top_regions</span><span class="p">)</span>
<span class="k">GROUP</span> <span class="k">BY</span> <span class="n">region</span><span class="p">,</span> <span class="n">product</span><span class="p">;</span></code></pre></div>

<p>以上语句的作用是统计畅销区域每种商品的销量。</p>

<p><code>RECURSIVE</code>修饰符为<code>WITH</code>语句增加了标准SQL没有的功能。采用<code>RECURSIVE</code>，<code>WITH</code>可以引用它自身的输出。一个简单的例子是计算1到100间整数之和：</p>

<div class="highlight"><pre><code class="language-sql"><span class="k">WITH</span> <span class="k">RECURSIVE</span> <span class="n">t</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="k">AS</span> <span class="p">(</span>
    <span class="k">VALUES</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span>
  <span class="k">UNION</span> <span class="k">ALL</span>
    <span class="k">SELECT</span> <span class="n">n</span><span class="o">+</span><span class="mi">1</span> <span class="k">FROM</span> <span class="n">t</span> <span class="k">WHERE</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">100</span>
<span class="p">)</span>
<span class="k">SELECT</span> <span class="k">sum</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="k">FROM</span> <span class="n">t</span><span class="p">;</span></code></pre></div>

<p>递归查询常用于处理树状结构的层次数据，比如查询某个产品直接部件和间接部件：</p>

<div class="highlight"><pre><code class="language-sql"><span class="k">WITH</span> <span class="k">RECURSIVE</span> <span class="n">included_parts</span><span class="p">(</span><span class="n">sub_part</span><span class="p">,</span> <span class="n">part</span><span class="p">,</span> <span class="n">quantity</span><span class="p">)</span> <span class="k">AS</span> <span class="p">(</span>
    <span class="k">SELECT</span> <span class="n">sub_part</span><span class="p">,</span> <span class="n">part</span><span class="p">,</span> <span class="n">quantity</span> <span class="k">FROM</span> <span class="n">parts</span> <span class="k">WHERE</span> <span class="n">part</span> <span class="o">=</span> <span class="s1">&#39;our_product&#39;</span>
  <span class="k">UNION</span> <span class="k">ALL</span>
    <span class="k">SELECT</span> <span class="n">p</span><span class="p">.</span><span class="n">sub_part</span><span class="p">,</span> <span class="n">p</span><span class="p">.</span><span class="n">part</span><span class="p">,</span> <span class="n">p</span><span class="p">.</span><span class="n">quantity</span>
    <span class="k">FROM</span> <span class="n">included_parts</span> <span class="n">pr</span><span class="p">,</span> <span class="n">parts</span> <span class="n">p</span>
    <span class="k">WHERE</span> <span class="n">p</span><span class="p">.</span><span class="n">part</span> <span class="o">=</span> <span class="n">pr</span><span class="p">.</span><span class="n">sub_part</span>
  <span class="p">)</span>
<span class="k">SELECT</span> <span class="n">sub_part</span><span class="p">,</span> <span class="k">SUM</span><span class="p">(</span><span class="n">quantity</span><span class="p">)</span> <span class="k">as</span> <span class="n">total_quantity</span>
<span class="k">FROM</span> <span class="n">included_parts</span>
<span class="k">GROUP</span> <span class="k">BY</span> <span class="n">sub_part</span></code></pre></div>

<p>上例中，our_product包含sub_part，sub_part又包含sub_part……，当然sub_part的层次是有限的，也就是包含关系不能构成圈。最终的表是our_product的每个层次sub_part的直接展示。</p>

<p>为了检查是否查询过相同的数据（避免圈），增加<code>path</code>和<code>cycle</code>两个字段：</p>

<div class="highlight"><pre><code class="language-sql"><span class="k">WITH</span> <span class="k">RECURSIVE</span> <span class="n">search_graph</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">link</span><span class="p">,</span> <span class="k">data</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="k">cycle</span><span class="p">)</span> <span class="k">AS</span> <span class="p">(</span>
        <span class="k">SELECT</span> <span class="k">g</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="k">g</span><span class="p">.</span><span class="n">link</span><span class="p">,</span> <span class="k">g</span><span class="p">.</span><span class="k">data</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
          <span class="nb">ARRAY</span><span class="p">[</span><span class="k">g</span><span class="p">.</span><span class="n">id</span><span class="p">],</span>
          <span class="k">false</span>
        <span class="k">FROM</span> <span class="n">graph</span> <span class="k">g</span>
      <span class="k">UNION</span> <span class="k">ALL</span>
        <span class="k">SELECT</span> <span class="k">g</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="k">g</span><span class="p">.</span><span class="n">link</span><span class="p">,</span> <span class="k">g</span><span class="p">.</span><span class="k">data</span><span class="p">,</span> <span class="n">sg</span><span class="p">.</span><span class="n">depth</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
          <span class="n">path</span> <span class="o">||</span> <span class="k">g</span><span class="p">.</span><span class="n">id</span><span class="p">,</span>
          <span class="k">g</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="k">ANY</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">FROM</span> <span class="n">graph</span> <span class="k">g</span><span class="p">,</span> <span class="n">search_graph</span> <span class="n">sg</span>
        <span class="k">WHERE</span> <span class="k">g</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">sg</span><span class="p">.</span><span class="n">link</span> <span class="k">AND</span> <span class="k">NOT</span> <span class="k">cycle</span>
<span class="p">)</span>
<span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">search_graph</span><span class="p">;</span></code></pre></div>

<p>通过需要多个字段判断是否有圈：</p>

<div class="highlight"><pre><code class="language-sql"><span class="k">WITH</span> <span class="k">RECURSIVE</span> <span class="n">search_graph</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">link</span><span class="p">,</span> <span class="k">data</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="k">cycle</span><span class="p">)</span> <span class="k">AS</span> <span class="p">(</span>
        <span class="k">SELECT</span> <span class="k">g</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="k">g</span><span class="p">.</span><span class="n">link</span><span class="p">,</span> <span class="k">g</span><span class="p">.</span><span class="k">data</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
          <span class="nb">ARRAY</span><span class="p">[</span><span class="k">ROW</span><span class="p">(</span><span class="k">g</span><span class="p">.</span><span class="n">f1</span><span class="p">,</span> <span class="k">g</span><span class="p">.</span><span class="n">f2</span><span class="p">)],</span>
          <span class="k">false</span>
        <span class="k">FROM</span> <span class="n">graph</span> <span class="k">g</span>
      <span class="k">UNION</span> <span class="k">ALL</span>
        <span class="k">SELECT</span> <span class="k">g</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="k">g</span><span class="p">.</span><span class="n">link</span><span class="p">,</span> <span class="k">g</span><span class="p">.</span><span class="k">data</span><span class="p">,</span> <span class="n">sg</span><span class="p">.</span><span class="n">depth</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
          <span class="n">path</span> <span class="o">||</span> <span class="k">ROW</span><span class="p">(</span><span class="k">g</span><span class="p">.</span><span class="n">f1</span><span class="p">,</span> <span class="k">g</span><span class="p">.</span><span class="n">f2</span><span class="p">),</span>
          <span class="k">ROW</span><span class="p">(</span><span class="k">g</span><span class="p">.</span><span class="n">f1</span><span class="p">,</span> <span class="k">g</span><span class="p">.</span><span class="n">f2</span><span class="p">)</span> <span class="o">=</span> <span class="k">ANY</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">FROM</span> <span class="n">graph</span> <span class="k">g</span><span class="p">,</span> <span class="n">search_graph</span> <span class="n">sg</span>
        <span class="k">WHERE</span> <span class="k">g</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">sg</span><span class="p">.</span><span class="n">link</span> <span class="k">AND</span> <span class="k">NOT</span> <span class="k">cycle</span>
<span class="p">)</span>
<span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">search_graph</span><span class="p">;</span></code></pre></div>

<p><strong>注意：</strong></p>

<ul>
  <li>当只需检测一个字段时，不必使用<code>ROW()</code>语法，这样效率更高。</li>
  <li>递归查询得到<code>path</code>的是深度优先遍历。</li>
</ul>

<p>利用<code>WITH</code>语句中修改表的语句，可以将表一分为二，这些修改表的语句通常都带有<code>RETURNING</code>返回项：</p>

<div class="highlight"><pre><code class="language-sql"><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">visit_log_roi</span> <span class="k">AS</span>
<span class="k">WITH</span> <span class="n">moved_rows</span> <span class="k">AS</span> <span class="p">(</span>
    <span class="k">DELETE</span> <span class="k">FROM</span> <span class="n">visit_log</span>
    <span class="k">WHERE</span>
        <span class="ss">&quot;time&quot;</span> <span class="o">&gt;=</span> <span class="s1">&#39;2014-12-06&#39;</span> <span class="k">AND</span>
        <span class="ss">&quot;time&quot;</span> <span class="o">&lt;</span> <span class="s1">&#39;2014-12-13&#39;</span>
    <span class="n">RETURNING</span> <span class="o">*</span>
<span class="p">)</span>
<span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">moved_rows</span><span class="p">;</span></code></pre></div>

<h2 id="section-20">聚合函数</h2>

<p>聚合函数（aggregate funciton）从一组输入数据计算出一个值，PostgreSQL有<a href="http://www.postgresql.org/docs/current/static/functions-aggregate.html#FUNCTIONS-AGGREGATE-TABLE">内建聚合函数</a>和<a href="http://www.postgresql.org/docs/current/static/functions-aggregate.html#FUNCTIONS-ORDEREDSET-TABLE">内建有序集聚合函数</a>。</p>

<h3 id="tutorial-agg">基本用法<sup id="fnref:tutorial-agg"><a href="#fn:tutorial-agg" class="footnote">4</a></sup></h3>

<p>常用的聚合函数是计算行构成集合的包含行的数目、元素和、平均值等。</p>

<div class="highlight"><pre><code class="language-sql"><span class="c1">-- 查询最高气温</span>
<span class="k">SELECT</span> <span class="k">max</span><span class="p">(</span><span class="n">temp_lo</span><span class="p">)</span> <span class="k">FROM</span> <span class="n">weather</span><span class="p">;</span>

<span class="c1">--  max</span>
<span class="c1">-- -----</span>
<span class="c1">--   46</span>
<span class="c1">-- (1 row)</span>

<span class="c1">-- 利用子查询，进一步得到最高气温的城市</span>
<span class="k">SELECT</span> <span class="n">city</span> <span class="k">FROM</span> <span class="n">weather</span>
    <span class="k">WHERE</span> <span class="n">temp_lo</span> <span class="o">=</span> <span class="p">(</span><span class="k">SELECT</span> <span class="k">max</span><span class="p">(</span><span class="n">temp_lo</span><span class="p">)</span> <span class="k">FROM</span> <span class="n">weather</span><span class="p">);</span>

<span class="c1">--      city</span>
<span class="c1">-- ---------------</span>
<span class="c1">--  San Francisco</span>
<span class="c1">-- (1 row)</span></code></pre></div>

<p>聚合函数通常与分组语句<code>GROUP BY</code>配合使用：</p>

<div class="highlight"><pre><code class="language-sql"><span class="c1">-- 查询每个城市的最高气温</span>
<span class="k">SELECT</span> <span class="n">city</span><span class="p">,</span> <span class="k">max</span><span class="p">(</span><span class="n">temp_lo</span><span class="p">)</span> <span class="k">FROM</span> <span class="n">weather</span> <span class="k">GROUP</span> <span class="k">BY</span> <span class="n">city</span><span class="p">;</span>

<span class="c1">--      city      | max</span>
<span class="c1">-- ---------------+-----</span>
<span class="c1">--  Hayward       |  37</span>
<span class="c1">--  San Francisco |  46</span>
<span class="c1">-- (2 rows)</span>

<span class="c1">-- 进一步过滤掉不满足条件的结果</span>
<span class="k">SELECT</span> <span class="n">city</span><span class="p">,</span> <span class="k">max</span><span class="p">(</span><span class="n">temp_lo</span><span class="p">)</span> <span class="k">FROM</span> <span class="n">weather</span> <span class="k">GROUP</span> <span class="k">BY</span> <span class="n">city</span> <span class="k">HAVING</span> <span class="k">max</span><span class="p">(</span><span class="n">temp_lo</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">40</span><span class="p">;</span>

<span class="c1">--   city   | max</span>
<span class="c1">-- ---------+-----</span>
<span class="c1">--  Hayward |  37</span>
<span class="c1">-- (1 row)</span></code></pre></div>

<p>聚合函数配合<code>WHERE</code>和<code>HAVING</code>限制条件：</p>

<div class="highlight"><pre><code class="language-sql"><span class="k">SELECT</span> <span class="n">city</span><span class="p">,</span> <span class="k">max</span><span class="p">(</span><span class="n">temp_lo</span><span class="p">)</span> 
  <span class="k">FROM</span> <span class="n">weather</span> <span class="k">WHERE</span> <span class="n">city</span> <span class="k">LIKE</span> <span class="s1">&#39;S%&#39;</span>
  <span class="k">GROUP</span> <span class="k">BY</span> <span class="n">city</span> <span class="k">HAVING</span> <span class="k">max</span><span class="p">(</span><span class="n">temp_lo</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">40</span><span class="p">;</span></code></pre></div>

<p><code>WHERE</code>语句限制进入<code>GROUP BY</code>的对象，<code>HAVING</code>过滤<code>GROUP BY</code>之后的对象，相同功能的限制条件一般在<code>WHERE</code>处效率更高。</p>

<h3 id="section-21">自定义聚合函数</h3>

<ul>
  <li>查看自定义聚合函数使用命令<code>\da</code>，删除自定义聚合函数使用<code>DROP AGGREGATE</code>。</li>
  <li>查看自定义函数（包括自定义聚合函数）使用命令<code>\df</code>，删除自定义函数使用<code>DROP FUNCTION</code>（不能删除自定义的聚合函数）。</li>
</ul>

<h2 id="sql-expressions">值表达式<sup id="fnref:sql-expressions"><a href="#fn:sql-expressions" class="footnote">5</a></sup></h2>

<h2 id="plpgsqlplpgsql">PL/pgSQL<sup id="fnref:plpgsql"><a href="#fn:plpgsql" class="footnote">6</a></sup></h2>

<p>PL/pgSQL是用于PostgreSQL数据库系统的可装载过程语言（procedural language），它主要实现如下功能：</p>

<ul>
  <li>创建函数与触发过程；</li>
  <li>为SQL语言加入控制结构；</li>
  <li>进行复杂的计算；</li>
  <li>继承所有用户定义的类型、函数和操作；</li>
  <li>服务器受信；</li>
  <li>易于使用。</li>
</ul>

<h2 id="plpythonplpython">PL/Python<sup id="fnref:plpython"><a href="#fn:plpython" class="footnote">7</a></sup></h2>

<p>PL/Python过程语言使得可以用Python语言写PostgreSQL函数。OSX用brew默认安装的PostgreSQL不支持Python，安装时需要参数<code>--with-python</code>：</p>

<div class="highlight"><pre><code class="language-bash"><span class="nv">$ </span>brew install  postgresql --with-python</code></pre></div>

<p>使用之前，需要先安装PL/Python插件。如果已经连接了某个数据库，直接创建插件：</p>

<div class="highlight"><pre><code class="language-sql"><span class="k">CREATE</span> <span class="n">EXTENSION</span> <span class="n">plpythonu</span><span class="p">;</span></code></pre></div>

<p>或者从shell命令行为特定的数据库安装插件：</p>

<div class="highlight"><pre><code class="language-bash"><span class="nv">$ </span>createlang plpythonu dbname</code></pre></div>

<p>PL/Python函数的基本语法：</p>

<div class="highlight"><pre><code class="language-sql"><span class="k">CREATE</span> <span class="k">FUNCTION</span> <span class="n">funcname</span> <span class="p">(</span><span class="n">argument</span><span class="o">-</span><span class="n">list</span><span class="p">)</span>
  <span class="k">RETURNS</span> <span class="k">return</span><span class="o">-</span><span class="k">type</span>
<span class="k">AS</span> <span class="err">$$</span>
  <span class="o">#</span> <span class="n">PL</span><span class="o">/</span><span class="n">Python</span> <span class="k">function</span> <span class="n">body</span>
<span class="err">$$</span> <span class="k">LANGUAGE</span> <span class="n">plpythonu</span><span class="p">;</span></code></pre></div>

<p>求两个数的较大值的示例：</p>

<div class="highlight"><pre><code class="language-sql"><span class="k">CREATE</span> <span class="k">FUNCTION</span> <span class="n">pymax</span> <span class="p">(</span><span class="n">a</span> <span class="nb">integer</span><span class="p">,</span> <span class="n">b</span> <span class="nb">integer</span><span class="p">)</span>
  <span class="k">RETURNS</span> <span class="nb">integer</span>
<span class="k">AS</span> <span class="err">$$</span>
  <span class="n">if</span> <span class="n">a</span> <span class="o">&gt;</span> <span class="n">b</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">a</span>
  <span class="k">return</span> <span class="n">b</span>
<span class="err">$$</span> <span class="k">LANGUAGE</span> <span class="n">plpythonu</span><span class="p">;</span>

<span class="c1">-- 测试</span>
<span class="k">select</span> <span class="n">pymax</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span><span class="mi">5</span><span class="p">);</span>

<span class="c1">--  pymax </span>
<span class="c1">-- -------</span>
<span class="c1">--     14</span>
<span class="c1">-- (1 row)</span></code></pre></div>

<div class="highlight"><pre><code class="language-sql"><span class="k">CREATE</span> <span class="k">FUNCTION</span> <span class="n">pystrip</span><span class="p">(</span><span class="n">x</span> <span class="nb">text</span><span class="p">)</span>
  <span class="k">RETURNS</span> <span class="nb">text</span>
<span class="k">AS</span> <span class="err">$$</span>
  <span class="k">global</span> <span class="n">x</span> <span class="o">#</span> 
  <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="p">.</span><span class="n">strip</span><span class="p">()</span>  <span class="o">#</span> <span class="n">ok</span> <span class="n">now</span>
  <span class="k">return</span> <span class="n">x</span>
<span class="err">$$</span> <span class="k">LANGUAGE</span> <span class="n">plpythonu</span><span class="p">;</span></code></pre></div>

<h2 id="section-22">参考资料</h2>

<ol class="bibliography"></ol>

<ul class="bibliography">
  <li><a href="http://www.postgresql.org/docs/current/interactive/index.html">PostgreSQL Documentation</a></li>
  <li><a href="http://pgsqlcn.com/">PostgreSQL 数据库文档</a></li>
  <li><a href="http://www.ruanyifeng.com/blog/2013/12/getting_started_with_postgresql.html">PostgreSQL新手入门</a></li>
  <li><a href="http://my.oschina.net/shuizeiguohe/blog/127529">在mac下启动postgresql</a></li>
  <li><a href="http://blog.chinaunix.net/uid-26642180-id-3485465.html">postgresql常用命令</a></li>
  <li><a href="http://www.cnblogs.com/stephen-liu74/archive/2012/05/18/2302639.html">PostgreSQL学习手册(角色和权限)</a></li>
</ul>

<div class="footnotes">
  <ol>
    <li id="fn:datatype">
      <p><a href="http://www.postgresql.org/docs/current/static/datatype.html">Data Types</a> <a href="#fnref:datatype" class="reversefootnote">&#8617;</a></p>
    </li>
    <li id="fn:functions-matching">
      <p><a href="http://www.postgresql.org/docs/current/static/functions-matching.html">Pattern Matching</a> <a href="#fnref:functions-matching" class="reversefootnote">&#8617;</a></p>
    </li>
    <li id="fn:ddl-alter">
      <p><a href="http://www.postgresql.org/docs/current/interactive/ddl-alter.html">Modifying Tables</a> <a href="#fnref:ddl-alter" class="reversefootnote">&#8617;</a></p>
    </li>
    <li id="fn:tutorial-agg">
      <p><a href="http://www.postgresql.org/docs/current/static/tutorial-agg.html">Aggregate Functions</a> <a href="#fnref:tutorial-agg" class="reversefootnote">&#8617;</a></p>
    </li>
    <li id="fn:sql-expressions">
      <p><a href="http://www.postgresql.org/docs/current/static/sql-expressions.html">Value Expressions</a> <a href="#fnref:sql-expressions" class="reversefootnote">&#8617;</a></p>
    </li>
    <li id="fn:plpgsql">
      <p><a href="http://www.postgresql.org/docs/current/static/plpgsql.html">PL/pgSQL - SQL Procedural Language</a> <a href="#fnref:plpgsql" class="reversefootnote">&#8617;</a></p>
    </li>
    <li id="fn:plpython">
      <p><a href="http://www.postgresql.org/docs/current/static/plpython.html">PL/Python - Python Procedural Language</a> <a href="#fnref:plpython" class="reversefootnote">&#8617;</a></p>
    </li>
  </ol>
</div>

</section>
<section align="left">
<p></p>
<hr>
  <p><img/ src="/assets/images/alipay2me.png" alt="打赏作者" style="height: 160px"></p>
  <p></p>
<hr>
  <ul>
    
    <li class="pageNav">2016-11-19 &raquo; <a href="/2016/11/ccf-bigdata-competition-about-state-grid">CCF 国家电网大数据竞赛</a></li>
    
    <li class="pageNav">2016-10-24 &raquo; <a href="/2016/10/nnml-bp-learning">NNML（03）：BP 学习</a></li>
    
    <li class="pageNav">2016-10-16 &raquo; <a href="/2016/10/nnml-perceptron-learning">NNML（02）：感知器学习</a></li>
    
    <li class="pageNav">2016-10-09 &raquo; <a href="/2016/10/s13000-model">鲁棒及自适应控制（2）：模型</a></li>
    
    <li class="pageNav">2016-10-09 &raquo; <a href="/2016/10/nnml_introduction">NNML（01）：引言</a></li>
    
    <li class="pageNav">2016-09-24 &raquo; <a href="/2016/09/feasibility-about-home-camera-in-power-syetem-monitoring">家用监控设备用于电网的可行性分析</a></li>
    
    <li class="pageNav">2016-09-19 &raquo; <a href="/2016/09/feasibility-about-uav-in-cable-tunnel">无人机电缆隧道巡检可行性调研报告</a></li>
    
    <li class="pageNav">2016-09-18 &raquo; <a href="/2016/09/s13000-Introduction">鲁棒及自适应控制（1）：概论</a></li>
    
  </ul>
<p></p>
<span>
  <a  href="/2015/04/camera-calibration" class="pageNav" style="float:left"   >上一篇：摄像机标定 </a>
  &nbsp;&nbsp;&nbsp;
  <a  href="/2015/04/r-packages" class="pageNav" style="float:right"   >下一篇：R包开发 </a>  
</span>
</section>

	<script type="text/javascript">
	var first_image = document.getElementsByClassName("post")[0].getElementsByTagName("img")[0]; 
	if (first_image != undefined) {
	document.getElementsByClassName("ds-thread")[0].setAttribute("data-image", first_image.src);
	}
	</script>
	<script type="text/javascript">
	var duoshuoQuery = {short_name:"jiyeqian"};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0] 
		|| document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
	</script>
	<ul class="ds-recent-visitors" data-num-items="16"></ul>
	<div class="ds-thread"  data-thread-key="/2015/04/postgresql-essential" 	data-url="http://qianjiye.de/2015/04/postgresql-essential" data-title="PostgreSQL Essential">
	</div>	


<!-- <script type="text/javascript"> -->
<!-- $(function(){ -->
<!--   $(document).keydown(function(e) { -->
<!--     var url = false; -->
<!--         if (e.which == 37 || e.which == 72) {  // Left arrow and H -->
<!--          -->
<!--         url = '/2015/04/camera-calibration'; -->
<!--          -->
<!--         } -->
<!--         else if (e.which == 39 || e.which == 76) {  // Right arrow and L -->
<!--          -->
<!--         <1!-- url = 'http://qianjiye.de/2015/04/r-packages'; --1> -->
<!--         url = '/2015/04/r-packages'; -->
<!--          -->
<!--         } else if (e.which == 75) {  // K -->
<!--           url = '#'; -->
<!--         } else if (e.which == 74) { // J -->
<!--         url = '/2015/04/postgresql-essential/#timeSpan'; -->
<!--         } -->
<!--         if (url) { -->
<!--             window.location = url; -->
<!--         } -->
<!--   }); -->
<!-- }) -->
<!-- </script> -->

        </article>
      </div>

    <footer>
        <p><small>
            Powered by <a href="http://jekyllrb.com" target="_blank">Jekyll</a> | Copyright 2014 - 2016 by <a href="/about/">Jiye Qian</a> | <span class="label label-info" id="timeSpan"></span></small></p>
    </footer>

    </div>
  </body>
</html>
